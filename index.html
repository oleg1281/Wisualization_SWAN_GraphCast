<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>üåä Prognoza pogody, fal i wiatru ‚Äî Morze Ba≈Çtyckie</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-velocity/dist/leaflet-velocity.min.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      background: #000;
      overflow: hidden;
      font-family: "Segoe UI", Arial, sans-serif;
    }

    /* === üåä –ú–æ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å –ø—Ä–æ–≥–Ω–æ–∑–∞ === */
    #forecast-panel {
      position: absolute;
      bottom: 0;                /* –≤—Å–µ–≥–¥–∞ —É –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä–∞—è */
      left: 0;
      width: 100%;

      background: linear-gradient(180deg, rgba(0,40,60,0) 0%, rgba(0,20,30,0.95) 60%, rgba(0,10,15,1) 100%);
      backdrop-filter: blur(14px) saturate(130%);
      -webkit-backdrop-filter: blur(14px) saturate(130%);

      border-top: 1px solid rgba(0, 255, 255, 0.25);
      box-shadow: inset 0 -12px 20px rgba(0, 0, 0, 0.6);

      color: #dffaff;
      overflow-x: auto;
      white-space: nowrap;
      padding: 10px 14px;
      z-index: 9999;
      text-align: center;

      /* üî• –ø–ª–∞–≤–Ω—ã–π –≤—ã–µ–∑–¥/–∑–∞–µ–∑–¥ */
      transform: translateY(0%);
      transition: transform 0.45s cubic-bezier(0.25, 0.1, 0.25, 1);

      /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ (–≤–∞–∂–Ω–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏!) */
      max-height: 260px;
    }

    /* === –ö–æ–≥–¥–∞ –∑–∞–∫—Ä—ã—Ç–æ ‚Äî —É–≤–µ–∑—Ç–∏ –≤–Ω–∏–∑ –Ω–∞ 60% === */
  #forecast-panel.closed {
    transform: translateY(45%);
  }

    /* --- –†—É—á–∫–∞ –ø–∞–Ω–µ–ª–∏ --- */
    #panel-handle {
      width: 65px;
      height: 6px;
      background: rgba(255,255,255,0.35);
      border-radius: 3px;
      margin: 8px auto 10px auto;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #panel-handle:hover {
      background: rgba(255,255,255,0.75);
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
    #forecast-title {
      font-size: 15px;
      font-weight: bold;
      color: #b8f4ff;
      text-shadow: 0 0 6px #00bcd4;
      margin-bottom: 6px;
      letter-spacing: 0.4px;
    }

    /* –¢–∞–±–ª–∏—Ü–∞ */
    #forecast-panel table {
      border: 1px solid rgba(0,255,255,0.25);
      border-collapse: collapse;
      width: max-content;
      
      text-align: center;
      font-size: 14px;
      line-height: 1.4;
      color: #dffaff;

      /* üî• –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º—É—é –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É */
      border-bottom: 2px solid rgba(0,255,255,0.35);
    }

    #forecast-panel td {
      border: 1px solid rgba(255,255,255,0.07);
      padding: 3px 5px;
      background: rgba(0,60,80,0.25);
      transition: background 0.3s;
    }
    #forecast-panel td:hover {
      background: rgba(0,200,255,0.25);
    }

    .active-time {
      background: rgba(0,188,212,0.6) !important;
      color: #fff !important;
    }

    .waves { color: #4de8ff; }
    .wind { color: #ffd633; }
    .temp { color: #ff9b7d; }
    .rain { color: #00baff; }
    .clouds { color: #b9ecff; }
    .pressure { color: #ffaa33; }

    /* === –£–∑–∫–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–µ–º === */
    #time-controls {
      position: absolute;
      bottom: 260px;
      left: 1px;
      display: none;
      align-items: center;
      justify-content: flex-start;
      width: 420px;
      height: 28px;
      background: rgba(0,40,60,0.3);
      border: 1px solid #00bcd466;
      border-radius: 10px;
      box-shadow: 0 0 10px #00bcd455;
      padding: 4px 10px;
      backdrop-filter: blur(8px);
      z-index: 99999;
      transform-origin: left center;
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }
    #time-controls:hover {
      transform: scale(1.03);
      box-shadow: 0 0 18px #00e5ff99;
      border-color: #00e5ffaa;
    }

    /* === –ö–Ω–æ–ø–∫–∞ Play === */
    #play-btn {
      background: radial-gradient(circle at 30% 30%, #00e5ff, #007a99);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      margin-right: 10px;
      font-size: 13px;
      box-shadow: 0 0 8px #00e5ff80;
      transition: all 0.3s ease;
    }
    #play-btn:hover {
      transform: scale(1.15);
      box-shadow: 0 0 15px #00e5ff;
    }

    /* === –ü–æ–ª–∑—É–Ω–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ === */
    #time-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 4px;
      background: linear-gradient(90deg, #00e5ff, #00bcd4);
      border-radius: 4px;
      outline: none;
      margin-right: 10px;
    }
    #time-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 0 10px #00e5ff;
      cursor: pointer;
    }

    #time-label {
      font-size: 11px;
      color: #d0f8ff;
      min-width: 90px;
      text-align: right;
    }

    /* === –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ === */
    .loading {
      animation: pulse 1.5s infinite;
      color: #00e5ff;
      font-weight: bold;
    }
    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }

    /* === –Ω–∞–¥–ø–∏—Å—å –Ω–∞–¥ —Ñ–ª–∞–∂–∫–æ–º === */
    .coord-label {
      background: rgba(0,0,0,0.4);
      color: #fff;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 11px;
      border: none;
      box-shadow: none;
    }

    /* === –ó–ê–ì–†–£–ó–ö–ê ‚Äî –ö–†–£–ñ–û–ö === */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.45);
      display: none;              /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
      align-items: center;
      justify-content: center;
      z-index: 999999;
    }
    .loader {
      border: 6px solid rgba(255,255,255,0.2);
      border-top: 6px solid #00e5ff;
      border-radius: 50%;
      width: 55px;
      height: 55px;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }


  </style>

  <style>
    /* –≥—Ä–∞—Ñ–∏–∫ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É */
    #wind-chart-box {
      position: fixed;
      top: 10px;
      right: 10px;

      background: rgba(0, 0, 0, 0.35);
      padding: 10px;
      border-radius: 10px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.2);

      /* üî• –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã */
      width: 400px;   /* –±—ã–ª–æ 260px */
      height: 220px;  /* –±—ã–ª–æ 160px */

      display: none;
      z-index: 999999;
    }

  </style>

  <style>
    /* –ö–Ω–æ–ø–∫–∞ Licencje */
    #license-btn {
      position: fixed;
      bottom: 285px;
      right: 10px;

      background: rgba(0, 60, 80, 0.7);
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid rgba(0,255,255,0.35);

      color: #dffaff;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;

      box-shadow: 0 0 12px rgba(0,255,255,0.25);
      backdrop-filter: blur(6px);

      z-index: 99999;
      transition: 0.25s;
    }
    #license-btn:hover {
      background: rgba(0,150,200,0.9);
      transform: scale(1.05);
    }


    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
    #license-modal {
      display: none; 
      position: fixed;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(4px);
      z-index: 999999;
      align-items: center;
      justify-content: center;
    }

    /* –û–∫–Ω–æ */
    #license-content {
      width: 480px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;

      background: rgba(0, 25, 40, 0.9);
      padding: 20px 25px;
      border-radius: 14px;
      border: 1px solid rgba(0,255,255,0.25);
      box-shadow: 0 0 30px rgba(0,255,255,0.25);
      
      color: #dffaff;
      font-size: 13px;
      line-height: 1.55;
    }

    /* –ó–∞–∫—Ä—ã—Ç—å (–∫—Ä–µ—Å—Ç–∏–∫) */
    #license-close {
      float: right;
      cursor: pointer;
      font-size: 18px;
      color: #66eaff;
      transition: 0.2s;
    }
    #license-close:hover {
      color: #ffffff;
      transform: scale(1.15);
    }

    #license-content h2 {
      color: #99ecff;
      margin-top: 0;
      text-align: center;
    }

    #license-content h3 {
      color: #4de8ff;
      margin-bottom: 6px;
    }

    #license-content a {
      color: #00e5ff;
    }
    #license-content a:hover {
      text-decoration: underline;
    }

  </style>
  <style>
    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –µ–¥–∏–Ω–∏—Ü –≤–µ—Ç—Ä–∞ ‚Äî –±–æ–ª—å—à–æ–π –∏ –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ Licencje */
    #wind-toggle {
      position: fixed;
      bottom: 320px;
      right: 10px;

      background: rgba(0, 60, 80, 0.7);
      padding: 8px 16px;      /* ‚Üê —É–º–µ–Ω—å—à–µ–Ω–æ */
      border-radius: 8px;     /* ‚Üê —á—É—Ç—å –º–µ–Ω—å—à–µ */
      border: 1px solid rgba(0,255,255,0.35);

      color: #dffaff;
      font-size: 12px;        /* ‚Üê —É–º–µ–Ω—å—à–µ–Ω–æ */
      font-weight: bold;
      cursor: pointer;

      box-shadow: 0 0 12px rgba(0,255,255,0.28);  /* –º—è–≥—á–µ */
      backdrop-filter: blur(6px);

      z-index: 99999;
      transition: 0.25s;
    }

    #wind-toggle:hover {
      background: rgba(0,150,200,0.9);
      transform: scale(1.06);
      box-shadow: 0 0 15px rgba(0,255,255,0.45);
    }
  </style>

  <style>
    /* –°—Ç–∞—Ç—É—Å—ã —Ä–∞–±–æ—Ç */
    .cell-go {
      background: rgba(0, 180, 90, 0.35) !important;
      color: #eafff3;
      font-weight: 600;
    }

    .cell-warn {
      background: rgba(255, 180, 0, 0.35) !important;
      color: #fff7db;
      font-weight: 600;
    }

    .cell-nogo {
      background: rgba(220, 60, 60, 0.45) !important;
      color: #ffecec;
      font-weight: 700;
    }
  </style>

  <style> 
    /* üåô –ù–æ—á–Ω—ã–µ —á–∞—Å—ã */
  .night-hour {
    background: rgba(120, 160, 200, 0.18) !important;
    color: #cfe6ff;
  }
  </style>

  <style>
    /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É –¥–Ω—è–º–∏ */
    .day-separator {
      border-right: 2px solid rgba(0, 200, 255, 0.35) !important;
      box-shadow: 2px 0 8px rgba(0, 200, 255, 0.15);
    }
  </style>

  <style>
    /* –∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä –Ω–∞ –∫–∞—Ä—Ç–µ */
    .temp-number {
      font-size: 10px;
      font-weight: 600;
      color: #ffffff;

      background: rgba(0, 0, 0, 0.45);   /* ‚Üê –∫–ª—é—á–µ–≤–æ–µ */
      padding: 2px 6px;
      border-radius: 6px;

      box-shadow:
        0 0 4px rgba(0,0,0,0.6),
        0 0 10px rgba(0,0,0,0.4);

      text-shadow:
        0 0 3px rgba(0,0,0,0.9);

      pointer-events: none;
      white-space: nowrap;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
  <button id="wind-toggle">Wiatr: m/s</button>

  <div id="map"></div>

  <div id="loading-overlay">
    <div class="loader"></div>
  </div>


  <div id="time-controls">
    <button id="play-btn">‚ñ∂</button>
    <input type="range" id="time-slider" min="0" max="55" step="1" value="0">
    <span id="time-label">01 wrz, 00:00</span>
  </div>

  <div id="forecast-panel">
    <div id="forecast-title" class="loading">‚è≥ ≈Åadowanie danych prognozy...</div>
  </div>

  <div id="wind-chart-box" style="display:none;">
    <canvas id="windChart"></canvas>
  </div>



  <script>
    let marker = null;
    /* =======================
      1) –ö–ê–†–¢–ê
    ======================= */
    const map = L.map("map", {
      center: [54.3, 18.6],
      zoom: 7,
      worldCopyJump: true,
      zoomControl: true
    });

    // =======================
    // üî∑ –ü–û–õ–ò–ì–û–ù–´ (GeoJSON)
    // =======================
    fetch("polygons.geojson")
      .then(r => r.json())
      .then(geojson => {
        L.geoJSON(geojson, {
          style: {
            color: "rgba(0, 255, 255, 0.9)",   // –∫–æ–Ω—Ç—É—Ä
            weight: 2,
            fillColor: "rgba(0, 180, 220, 0.65)", // –ø–ª–æ—Ç–Ω—ã–π –º–æ—Ä—Å–∫–æ–π —Ü–≤–µ—Ç
            fillOpacity: 0.28                  // ‚Üê –∫–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
          }
        }).addTo(map);
      });

    // =======================
    // TEMPERATURE NUMBERS LAYER
    // =======================
    const tempNumbersLayer = L.layerGroup().addTo(map);
    tempNumbersLayer.getPane?.()?.style && (tempNumbersLayer.getPane().style.zIndex = 650);

    function drawTemperatureNumbers(points) {
      tempNumbersLayer.clearLayers();
      const zoom = map.getZoom();

      let step = 1;
      if (zoom <= 5) step = 8;
      else if (zoom <= 6) step = 4;
      else if (zoom <= 7) step = 2;
      else if (zoom <= 8) step = 1;

      points.forEach(p => {
        if (
          Math.abs(p.lat) % step !== 0 ||
          Math.abs(p.lon) % step !== 0
        ) return;

        const icon = L.divIcon({
          className: "temp-number",
          html: `<div>${p.temp}¬∞C</div>`,
          iconSize: [28, 16],
          iconAnchor: [14, 8]
        });

        L.marker([p.lat, p.lon], { icon }).addTo(tempNumbersLayer);
      });

      updateTempScale();
    }


    function loadTemperatureGrid(timeIdx = 0) {
      fetch(`http://10.0.1.6:8000/api/temp_grid?time_idx=${timeIdx}`)
        .then(r => r.json())
        .then(data => {
          drawTemperatureNumbers(data.points);
        })
        .catch(err => console.error("Temp grid error:", err));
    }

    map.on("click", function (e) {
      const lat = e.latlng.lat;
      const lon = e.latlng.lng;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      showLoader();

      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä
      if (marker) {
        map.removeLayer(marker);
      }

      // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
      marker = L.marker([lat, lon])
        .addTo(map)
        .bindTooltip(
          `${lat.toFixed(4)}, ${lon.toFixed(4)}`,
          {
            permanent: true,
            direction: "top",
            offset: [0, -10],
            className: "coord-label"
          }
        )
        .openTooltip();
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ FastAPI
      sendCoordsToAPI(lat, lon).finally(() => hideLoader());
    });

    map.on("zoomend", () => {
      loadTemperatureGrid(currentStep);
    });

    const esriSatellite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 18,
        attribution: "Tiles ¬© Esri"
      }
    );

    const esriLabels = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 18,
        pane: "overlayPane"
      }
    );

    const oceanLabels = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 18,
        pane: "overlayPane"
      }
    );

    esriSatellite.addTo(map);
    oceanLabels.addTo(map);
    esriLabels.addTo(map);

    esriLabels.getContainer().style.opacity = "0.55";
    oceanLabels.getContainer().style.opacity = "0.55";


    /* =======================
      2) –í–ï–¢–ï–†
    ======================= */
    function buildVelocityData(intensity, timeStep) {
      const nx = 80, ny = 40;
      const header = { nx, ny, lo1: -180, la1: 90, dx: 360/nx, dy: 180/ny };
      const uData = [], vData = [];
      const t = timeStep * 0.35;
      for (let j = 0; j < ny; j++) {
        for (let i = 0; i < nx; i++) {
          const u = intensity * (Math.sin((i + t) / 6) * Math.cos((j - t) / 8) + 0.25*Math.sin(i/9 + j/11 + t/3));
          const v = intensity * (Math.cos((i - t) / 8) * Math.sin((j + t) / 6) + 0.25*Math.cos(i/10 - j/12 + t/4));
          uData.push(u);
          vData.push(v);
        }
      }
      return [
        { header: { ...header, parameterCategory: 2, parameterNumber: 2 }, data: uData },
        { header: { ...header, parameterCategory: 2, parameterNumber: 3 }, data: vData }
      ];
    }

    function createVelocityLayer(data) {
      return L.velocityLayer({
        data,
        displayValues: false,
        maxVelocity: 20,
        velocityScale: 0.08,
        particleMultiplier: 0.0015,
        particleAge: 90,
        lineWidth: 1,
        colorScale: ['#00ffff','#00ff80','#ffff00','#ff8000','#ff0000']
      });
    }

    //let windLayer = createVelocityLayer(buildVelocityData(5, 0)).addTo(map);
    let isFading = false;

    function fadeSwapWindLayer(intensity, step) {
      if (isFading) return;
      isFading = true;

      const nextData = buildVelocityData(intensity, step);
      const nextLayer = createVelocityLayer(nextData).addTo(map);

      const oldCanvas = windLayer?._canvas || null;
      const newCanvas = nextLayer._canvas;

      if (oldCanvas) oldCanvas.style.opacity = 1;
      if (newCanvas) newCanvas.style.opacity = 0;

      setTimeout(() => {
        let alpha = 0;
        const fadeDuration = 1500, stepMs = 40;
        const interval = setInterval(() => {
          alpha += stepMs / fadeDuration;
          if (alpha <= 1) {
            if (newCanvas) newCanvas.style.opacity = alpha.toFixed(2);
            if (oldCanvas) oldCanvas.style.opacity = (1 - alpha).toFixed(2);
          } else {
            clearInterval(interval);
            if (oldCanvas) oldCanvas.style.opacity = 0;
            if (newCanvas) newCanvas.style.opacity = 1;
            map.removeLayer(windLayer);
            windLayer = nextLayer;
            isFading = false;
          }
        }, stepMs);
      }, 200);
    }

    function sendCoordsToAPI(lat, lon) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –≥—Ä–∞—Ñ–∏–∫–∞
      document.getElementById("wind-chart-box").style.display = "block";
      return fetch(`http://10.0.1.6:8000/api/forecast?lat=${lat}&lon=${lon}`)
        .then(r => r.json())
        .then(data => {
          console.log("–û—Ç–≤–µ—Ç FastAPI:", data);

          forecast = data;
          document.getElementById("forecast-panel").innerHTML = buildForecastPanel();
          //onTimeChange(0);
          // üî• –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –≤–µ—Ç—Ä–∞ —Ä—è–¥–æ–º —Å –º–∞—Ä–∫–µ—Ä–æ–º
          updateWindChart(data.wind_kt, data.waves, data.time);
        })
        .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err));
    }

    /* ===========================
      –ü–û–õ–ù–û–≠–ö–†–ê–ù–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê
    =========================== */
    function showLoader() {
      document.getElementById("loading-overlay").style.display = "flex";
    }

    function hideLoader() {
      document.getElementById("loading-overlay").style.display = "none";
    }

    /* =======================
      3) –ü–†–û–ì–ù–û–ó
    ======================= */
    const days = 14, hoursStep = 6, pointsPerDay = 24 / hoursStep;
    const totalSteps = days * pointsPerDay;
    let forecast = null;

    fetch("http://10.0.1.6:8000/api/forecast")
      .then(resp => resp.json())
      .then(data => {
        forecast = data;
        document.getElementById("forecast-panel").innerHTML = buildForecastPanel();
        //onTimeChange(0);
      })
      .catch(err => {
        console.error("‚ùå B≈ÇƒÖd ≈Çadowania danych:", err);
        document.getElementById("forecast-panel").innerHTML =
          "<div id='forecast-title'>‚ö†Ô∏è Nie uda≈Ço siƒô za≈Çadowaƒá danych prognozy</div>";
      });

    /* ================================
      3a) –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–õ–ò–ö–ê –ü–û –†–£–ß–ö–ï
    ================================ */
    document.addEventListener("click", (e) => {
      if (e.target.id === "panel-handle") {
        const panel = document.getElementById("forecast-panel");
        panel.classList.toggle("closed");
      }
    });

    function buildForecastPanel() {
      if (!forecast) return "";
      const { time, waves, wind_kt, temp, rain, clouds, pressure } = forecast;

      // === –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–Ω—è–º ===
      const dayGroups = [];
      let currentDay = null;

      time.forEach((t, i) => {
        const d = new Date(t);
        const dayKey =
          d.getFullYear() + "-" +
          String(d.getMonth() + 1).padStart(2, "0") + "-" +
          String(d.getDate()).padStart(2, "0");

        if (!currentDay || currentDay.key !== dayKey) {
          currentDay = {
            key: dayKey,
            weekday: d.toLocaleString("pl", { weekday: "long" }),
            isWeekend: d.getDay() === 0 || d.getDay() === 6,
            count: 1
          };
          dayGroups.push(currentDay);
        } else {
          currentDay.count++;
        }
      });

      const dateLabels = time.map(t => {
        const d = new Date(t);
        const day = d.getDate();
        const month = d.toLocaleString('pl', { month: 'short' });
        const hour = d.getHours().toString().padStart(2, "0");
        const minute = d.getMinutes().toString().padStart(2, "0");

        return `
          <div style="font-size:10px; color:#b9ecff;">${day} ${month}</div>
          <div style="font-size:12px; font-weight:bold; color:#fff;">${hour}:${minute}</div>
        `;
      });

      setTimeout(() => {
        const table = document.getElementById("forecast-table");
        if (!table) return;

        let colIndex = 1; // –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫

        dayGroups.forEach(day => {
          colIndex += day.count; // –∫–æ–Ω–µ—Ü –¥–Ω—è

          // –¥–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏—é –∫–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º
          Array.from(table.rows).forEach(row => {
            const cell = row.cells[colIndex - 1];
            if (cell) cell.classList.add("day-separator");
          });
        });
      }, 0);

      return `
        <div id="panel-handle"></div>     <!-- üî• —Ä—É—á–∫–∞ –ø–∞–Ω–µ–ª–∏ -->
        <div id="forecast-title"></div>
        <table id="forecast-table">
          <tr>
            <td></td>
            ${dayGroups.map(d => `
              <td colspan="${d.count}"
                  class="day-header ${d.isWeekend ? "weekend" : ""}">
                ${d.weekday}
              </td>
            `).join("")}
          </tr>
          <tr><td>Data</td>${dateLabels.map(d=>`<td>${d}</td>`).join("")}<td style="min-width:20px;"></td></tr>
          <tr class="waves"><td>üåä Fale (m)</td>${forecast.waves.map(w =>`<td class="${waveClass(w)}">${w}</td>`).join("")}</tr>
          <tr class="wind">
            <td>üí® Wiatr ${useKt ? "(kt)" : "(m/s)"}</td>
            ${forecast.wind_ms.map((wMs) => {
              const cls = windClass(wMs);
              const value = useKt
                ? (wMs * 1.94384).toFixed(1)
                : wMs.toFixed(1);

              return `<td class="${cls}">${value}</td>`;
            }).join("")}
          </tr>
          <tr class="temp"><td>üå° Temp (¬∞C)</td>${temp.map(v=>`<td>${v}</td>`).join("")}</tr>
          <tr class="rain"><td>üåß Opady (mm)</td>${rain.map(v=>`<td>${v}</td>`).join("")}</tr>
          <tr class="clouds"><td>‚òÅÔ∏è Zachmurzenie (%)</td>${clouds.map(v => `<td>${v}</td>`).join("")}</tr>
          <tr class="pressure"><td>üîΩ Ci≈õnienie (hPa)</td>${pressure.map(v=>`<td>${v}</td>`).join("")}</tr>
        </table>`;
    }

    function highlightTime(step) {
      const tds = document.querySelectorAll("#forecast-table td");
      tds.forEach(td => td.classList.remove("active-time"));
      const col = step + 1;
      document.querySelectorAll("#forecast-table tr").forEach(tr => {
        const cell = tr.children[col];
        if (cell) cell.classList.add("active-time");
      });
    }

    /* =======================
      4) –í–†–ï–ú–ï–ù–ù–ê–Ø –®–ö–ê–õ–ê + –ü–õ–ï–ô
    ======================= */
    const slider = document.getElementById("time-slider");
    const playBtn = document.getElementById("play-btn");
    const timeLabel = document.getElementById("time-label");

    let currentStep = 0, playing = false, timer = null;

    function updateTimeLabel(step) {
      const day = Math.floor(step / pointsPerDay);
      const hour = (step % pointsPerDay) * 6;
      const date = new Date(2025, 8, 1 + day, hour);
      timeLabel.textContent = date.toLocaleString("pl", {
        day: "2-digit", month: "short", hour: "2-digit", minute: "2-digit"
      });
    }

    function onTimeChange(step) {
      if (!forecast) return;
      currentStep = step;
      highlightTime(currentStep);
      updateTimeLabel(currentStep);
      //const windIntensity = 2 + (Number(forecast.wind[currentStep]) / 3);
      //fadeSwapWindLayer(windIntensity, currentStep);
    }

    slider.addEventListener("input", () => onTimeChange(+slider.value));

    playBtn.addEventListener("click", () => {
      playing = !playing;
      playBtn.textContent = playing ? "‚è∏" : "‚ñ∂";
      if (playing) {
        if (timer) clearInterval(timer);
        timer = setInterval(() => {
          currentStep = (currentStep + 1) % totalSteps;
          slider.value = currentStep;
          onTimeChange(currentStep);
        }, 2400);
      } else {
        if (timer) clearInterval(timer);
      }
    });

    /* –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ –æ–∫–æ–ª–æ —Ñ–ª–∞–∂–∫–∞ */
    let windChart = null;

    function updateWindChart(windValues, waveValues, times) {
      const box = document.getElementById("wind-chart-box");
      box.style.display = "block";

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–µ 20 –ø—É–Ω–∫—Ç–æ–≤ (5 –¥–Ω–µ–π)
      const wind5 = windValues.slice(0, 20);
      const wave5 = waveValues.slice(0, 20);
      const time5 = times.slice(0, 20);

      if (!wind5 || wind5.length === 0) {
        box.innerHTML = "<p style='color:white'>Brak danych</p>";
        return;
      }

      const ctx = document.getElementById("windChart").getContext("2d");

      if (windChart) windChart.destroy();

      // –î–∞—Ç—ã –Ω–∞ X
      const labels = time5.map(t => {
        const d = new Date(t);
        return d.toLocaleString("pl", {
          day: "2-digit",
          month: "short",
          hour: "2-digit",
          minute: "2-digit"
        });
      });

      // –≥—Ä–∞—Ñ–∏–∫–∏
      windChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: useKt ? "Wiatr (kt)" : "Wiatr (m/s)",
              data: wind5,
              borderColor: "rgba(255, 210, 0, 0.9)",
              backgroundColor: "rgba(255, 210, 0, 0.25)",
              borderWidth: 2,
              tension: 0.35,
              yAxisID: "y1"
            },
            {
              label: "Fale (m)",
              data: wave5,
              borderColor: "rgba(0, 200, 255, 0.85)",
              backgroundColor: "rgba(0, 200, 255, 0.25)",
              borderWidth: 2,
              tension: 0.35,
              yAxisID: "y2"
            }
          ]
        },
        options: {
          plugins: {
            legend: { display: true, labels: { color: "white", font: { size: 10 } } }
          },
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                color: "white",
                maxRotation: 75,
                minRotation: 45,
                autoSkip: false,
                font: { size: 10 }
              },
              grid: { color: "rgba(255,255,255,0.1)" }
            },
            y1: {
              position: "left",
              min: 0,
              max: 30,
              ticks: { stepSize: 5, color: "white" },
              grid: { color: "rgba(255,255,255,0.15)" },
              title: {
                display: true,
                text: useKt ? "Wiatr (kt)" : "Wiatr (m/s)", 
                color: "white",
                font: { size: 11 }
              }
            },
            y2: {
              position: "right",
              min: 0,
              max: 3,
              ticks: { color: "white" },
              grid: { drawOnChartArea: false },
              title: {
                display: true,
                text: "Fale (m)",
                color: "white",
                font: { size: 11 }
              }
            }
          }
        }
      });
    }

    // =======================
    // üöÄ –ê–í–¢–û–°–¢–ê–†–¢ ‚Äî –ì–î–ê–ù–¨–°–ö
    // =======================
    const START_LAT = 54.3520;
    const START_LON = 18.6466;

    map.whenReady(() => {
      map.fire("click", {
        latlng: L.latLng(START_LAT, START_LON)
      });
    });

    loadTemperatureGrid(0);
  </script>

  
  <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è -->
  <div id="license-btn">‚ìò Licencje</div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="license-modal">
    <div id="license-content">
      <span id="license-close">‚úï</span>

      <h2>Licencje i ≈∫r√≥d≈Ça danych</h2>

      <h3>üåê NOAA / NWS</h3>
      <p>
        Dane meteorologiczne NOAA (National Oceanic and Atmospheric Administration)
        znajdujƒÖ siƒô w domenie publicznej (Public Domain) i mogƒÖ byƒá u≈ºywane
        bez ogranicze≈Ñ, r√≥wnie≈º w celach komercyjnych.<br>
        <a href="https://www.weather.gov/disclaimer" target="_blank">
          https://www.weather.gov/disclaimer
        </a>
      </p>

      <h3>üß† GraphCast ‚Äî DeepMind / Google</h3>
      <p>
        Model prognostyczny GraphCast oraz jego wagi sƒÖ objƒôte licencjƒÖ
        <strong>Creative Commons CC BY-NC 4.0</strong> (bez u≈ºycia komercyjnego).<br>
        Prognozy oparte na modelu GraphCast sƒÖ wykorzystywane
        <strong>wy≈ÇƒÖcznie do wewnƒôtrznych cel√≥w analitycznych, badawczych
        i wspomagania decyzji</strong> w ramach dzia≈Çalno≈õci firmy.
        Dane te nie sƒÖ sprzedawane ani udostƒôpniane publicznie.<br>
        ¬© DeepMind / Google Research<br>
        <a href="https://github.com/google-deepmind/graphcast" target="_blank">
          https://github.com/google-deepmind/graphcast
        </a>
      </p>

      <h3>üåä SWAN ‚Äî Delft University of Technology</h3>
      <p>
        Model falowy SWAN (Simulating WAves Nearshore) ¬© Delft University of Technology.<br>
        Oprogramowanie dostƒôpne jest bezp≈Çatnie do zastosowa≈Ñ naukowych,
        badawczych oraz in≈ºynierskich.<br>
        <a href="https://swanmodel.sourceforge.io/" target="_blank">
          https://swanmodel.sourceforge.io/
        </a>
      </p>

      <h3>üó∫ Mapy bazowe</h3>
      <p>
        Mapy bazowe (podk≈Çady kartograficzne) dostarczane sƒÖ przez
        <strong>Esri</strong> i wykorzystywane wy≈ÇƒÖcznie jako warstwa wizualna
        do prezentacji danych prognostycznych.<br>
        ¬© Esri, Maxar, Earthstar Geographics, CNES/Airbus, USGS, NOAA
      </p>

    </div>
  </div>


  <script>
    document.getElementById("license-btn").onclick = () =>
      document.getElementById("license-modal").style.display = "flex";

    document.getElementById("license-close").onclick = () =>
      document.getElementById("license-modal").style.display = "none";

    document.getElementById("license-modal").onclick = (e) => {
      if (e.target === document.getElementById("license-modal"))
        document.getElementById("license-modal").style.display = "none";
    };
  </script>
  <script>
    let useKt = false;

    document.getElementById("wind-toggle").onclick = () => {
        useKt = !useKt;
        document.getElementById("wind-toggle").textContent = useKt ? "Wiatr: KT" : "Wiatr: m/s";

        // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
        document.getElementById("forecast-panel").innerHTML = buildForecastPanel();

        // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫
        updateWindChart(
            useKt ? forecast.wind_kt : forecast.wind_ms,
            forecast.waves,
            forecast.time
        );
    };

  </script>

  <script>
    function waveClass(wave) {
      if (wave > 1.5) return "cell-nogo";
      if (wave >= 1.0) return "cell-warn";
      return "cell-go";
    }
    function windClass(windMs) {
      if (windMs > 10.0) return "cell-nogo";
      if (windMs >= 9.0) return "cell-warn";
      return "cell-go";
    }
  </script>

</body>
</html>
